{"hidden":false,"children":[{"configs":{"itemId":"module"},"expanded":true,"children":[{"configs":{"layout":"fit","itemId":"editWin","dialog":"true","createInstance":"false","focusControl":"TASK_NAME","resizable":"true","width":"712","autoShow":"true","height":"500","maximizable":"true"},"expanded":true,"children":[{"configs":{"itemId":"propertyTab","transparent":"true","deferredRender":"false"},"expanded":true,"children":[{"configs":{"layout":"absolute","itemId":"generalPage","width":"688","title":"常规","iconCls":"property_icon","transparent":"true","height":"264"},"expanded":true,"children":[{"configs":{"itemId":"taskNameLbl","labelAlign":"right","width":"80","x":"16","y":"16","text":"任务名称：","height":"22"},"expanded":false,"children":[],"type":"label"},{"configs":{"allowBlank":"false","itemId":"TASK_NAME","labelAlign":"right","width":"568","x":"104","y":"16","height":"22"},"expanded":false,"children":[],"type":"text"},{"configs":{"itemId":"intervalLbl","labelAlign":"right","width":"80","x":"16","y":"48","text":"周期：","height":"22"},"expanded":false,"children":[],"type":"label"},{"configs":{"allowBlank":"false","itemId":"INTERVAL_TYPE","width":"568","x":"104","y":"48","height":"22"},"expanded":false,"children":[{"configs":{"itemId":"radio1","boxLabel":"秒","name":"intervalType"},"expanded":false,"children":[],"type":"radio"},{"configs":{"itemId":"radio2","boxLabel":"分","name":"intervalType"},"expanded":false,"children":[],"type":"radio"},{"configs":{"itemId":"radio3","boxLabel":"时","name":"intervalType"},"expanded":false,"children":[],"type":"radio"},{"configs":{"itemId":"radio4","boxLabel":"日","name":"intervalType"},"expanded":false,"children":[],"type":"radio"},{"configs":{"itemId":"radio5","boxLabel":"周","name":"intervalType"},"expanded":false,"children":[],"type":"radio"},{"configs":{"itemId":"radio6","boxLabel":"月","name":"intervalType"},"expanded":false,"children":[],"type":"radio"}],"type":"radiogroup","events":{"change":"var i = radiogroup.getValue();\napp.prefixLabel.setVisible(i != 3);\napp.intervalNumber.setVisible(i != 3 && i != 4);\napp.weekdaysCombo.setVisible(i == 4);\napp.suffixLabel.setVisible(i < 3);\napp.spaceLabel.setVisible(i != 3);\napp.timeLabel.setVisible(i > 2);\napp.intervalTime.setVisible(i > 2);\nswitch (i) {\n  case 0:\n    app.prefixLabel.setText('每');\n    app.suffixLabel.setText('秒');\n    break;\n  case 1:\n    app.prefixLabel.setText('每');\n    app.suffixLabel.setText('分');\n    break;\n  case 2:\n    app.prefixLabel.setText('每');\n    app.suffixLabel.setText('小时');\n    break;\n  case 4:\n    app.prefixLabel.setText('周：');\n    break;\n  case 5:\n    app.prefixLabel.setText('日期：');\n    break;\n}"}},{"configs":{"layout":"column","itemId":"intervalSet","width":"568","x":"104","y":"80","height":"22"},"expanded":true,"children":[{"configs":{"itemId":"prefixLabel","padding":"0 8 0 0"},"expanded":false,"children":[],"type":"label"},{"configs":{"allowBlank":"false","itemId":"intervalNumber","allowDecimals":"false","width":"100"},"expanded":false,"children":[],"type":"number"},{"configs":{"allowBlank":"false","itemId":"weekdaysCombo","pickList":"app.weekDays","width":"100","forceSelection":"true"},"expanded":false,"children":[],"type":"combo"},{"configs":{"itemId":"suffixLabel","padding":"0 0 0 8"},"expanded":false,"children":[],"type":"label"},{"configs":{"itemId":"spaceLabel","padding":"0 24 0 0"},"expanded":false,"children":[],"type":"label"},{"configs":{"itemId":"timeLabel","padding":"0 8 0 0","text":"时间："},"expanded":false,"children":[],"type":"label"},{"configs":{"allowBlank":"false","itemId":"intervalTime","width":"100","format":"H:i"},"expanded":false,"children":[],"type":"time"}],"type":"container"},{"configs":{"itemId":"beginLbl","labelAlign":"right","width":"80","x":"16","y":"112","text":"开始时间：","height":"22"},"expanded":false,"children":[],"type":"label"},{"configs":{"itemId":"BEGIN_DATE","dateFormat":"Y-m-d","labelAlign":"right","timeFormat":"H:i:s","width":"240","x":"104","y":"112","height":"22"},"expanded":false,"children":[],"type":"datetime","events":{"change":"app.END_DATE.dateField.setMinValue(app.BEGIN_DATE.dateField.getValue());"}},{"configs":{"itemId":"endLbl","labelAlign":"right","width":"72","x":"352","y":"112","text":"结束时间：","height":"22"},"expanded":false,"children":[],"type":"label"},{"configs":{"itemId":"END_DATE","dateFormat":"Y-m-d","labelAlign":"right","timeFormat":"H:i:s","width":"240","x":"432","y":"112","height":"22"},"expanded":false,"children":[],"type":"datetime"},{"configs":{"itemId":"classLbl","labelAlign":"right","width":"80","x":"16","y":"144","text":"类全名：","height":"22"},"expanded":false,"children":[],"type":"label"},{"configs":{"itemId":"CLASS_NAME","width":"568","x":"104","y":"144","height":"22"},"expanded":false,"children":[],"type":"text"},{"configs":{"itemId":"remarkLbl","labelAlign":"right","width":"80","x":"16","y":"176","text":"备注：","height":"22"},"expanded":false,"children":[],"type":"label"},{"configs":{"itemId":"REMARK","labelAlign":"right","width":"568","x":"104","y":"176","height":"22"},"expanded":false,"children":[],"type":"text"},{"configs":{"itemId":"INTERVAL_EXPRESS","width":"100","x":"104","y":"200","height":"22"},"expanded":false,"children":[],"type":"hidden"},{"configs":{"itemId":"STATUS","width":"100","x":"240","y":"200","height":"22"},"expanded":false,"children":[],"type":"hidden"},{"configs":{"itemId":"SERVER_SCRIPT","width":"100","x":"368","y":"200","height":"22"},"expanded":false,"children":[],"type":"hidden"}],"type":"panel"},{"configs":{"itemId":"scriptPanel","title":"脚本","iconCls":"file_ss_icon"},"expanded":false,"children":[],"type":"panel","events":{"activate":"setTimeout(function() {\n  app.scriptEditor.refresh();\n  app.scriptEditor.focus();\n}, 10);"}}],"type":"tab"}],"type":"window","events":{"hide":"Wb.reset(win);\napp.scriptEditor.setValue('');","ok":"var intervalType = app.INTERVAL_TYPE.getValue(),\n  intervalExpress, val = app.intervalNumber.getValue(),\n  time = app.intervalTime.getValue();\ntime = time ? Wb.format(time, 'H:i') : '';\napp.SERVER_SCRIPT.setValue(app.scriptEditor.getValue());\nswitch (intervalType) {\n  case 0:\n  case 1:\n  case 2:\n    intervalExpress = val;\n    break;\n  case 3:\n    intervalExpress = time;\n    break;\n  case 4:\n    intervalExpress = app.weekdaysCombo.getValue() + ':' + time;\n    break;\n  case 5:\n    intervalExpress = val + ':' + time;\n    break;\n}\napp.INTERVAL_EXPRESS.setValue(intervalExpress.toString());\nwin.editHandler();"}},{"configs":{"layout":"fit","itemId":"viewport1"},"expanded":true,"children":[{"configs":{"itemId":"grid1","pagingBar":"false","multiSelect":"true"},"expanded":true,"children":[{"configs":{"itemId":"store","normalName":"taskStore","autoLoad":"true","pageSize":"-1","fields":"['TASK_ID', 'TASK_NAME', 'INTERVAL_TYPE', 'INTERVAL_EXPRESS',\n  'CLASS_NAME', 'SERVER_SCRIPT',\n  'STATUS', 'REMARK', {\n    name: 'BEGIN_DATE',\n    dateFormat: Wb.dateFormat,\n    type: 'date'\n  }, {\n    name: 'END_DATE',\n    dateFormat: Wb.dateFormat,\n    type: 'date'\n  }, {\n    name: 'PREVIOUS',\n    dateFormat: Wb.dateFormat,\n    type: 'date'\n  }, {\n    name: 'NEXT',\n    dateFormat: Wb.dateFormat,\n    type: 'date'\n  }\n]","url":"m?xwl=admin/task/get-tasks"},"expanded":false,"children":[],"type":"store"},{"configs":{"itemId":"tbar"},"expanded":true,"children":[{"configs":{"itemId":"newBtn","tooltip":"添加新的计划任务 (Ctrl+E)","text":"添加","iconCls":"record_add_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"app.createWin(function(win) {\n  app.STATUS.setValue(1);\n  Wb.insert(app.grid1, {\n    win: app.editWin,\n    url: 'm?xwl=admin/task/insert'\n  });\n  app.propertyTab.setActiveTab(app.generalPage);\n  app.INTERVAL_TYPE.setValue(3);\n});"}},{"configs":{"itemId":"editBtn","tooltip":"修改选择的计划任务","text":"修改","iconCls":"record_edit_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"if (!app.checkSelection())\n  return;\napp.createWin(function(win) {\n  Wb.edit(app.grid1, {\n    win: app.editWin,\n    titleField: 'TASK_NAME',\n    url: 'm?xwl=admin/task/update'\n  });\n  app.scriptEditor.setValue(app.SERVER_SCRIPT.getValue() || '');\n  var i = app.INTERVAL_TYPE.getValue(),\n    v = app.INTERVAL_EXPRESS.getValue().split(':'),\n    setTime = function() {\n      app.intervalTime.setValue(Ext.Date.parse(v[1] + ':' + v[2], 'H:i'));\n    };\n  switch (i) {\n    case 0:\n    case 1:\n    case 2:\n      app.intervalNumber.setValue(v[0]);\n      break;\n    case 3:\n      app.intervalTime.setValue(Ext.Date.parse(v[0] + ':' + v[1], 'H:i'));\n      break;\n    case 4:\n      app.weekdaysCombo.setValue(parseInt(v[0], 10));\n      setTime();\n      break;\n    case 5:\n      app.intervalNumber.setValue(v[0]);\n      setTime();\n      break;\n  }\n});"}},{"configs":{"itemId":"delBtn","tooltip":"删除选择的计划任务","text":"删除","iconCls":"record_delete_icon"},"expanded":true,"children":[],"type":"item","events":{"click":"Wb.del(app.grid1, {\n  url: 'm?xwl=admin/task/delete',\n  titleField: 'TASK_NAME'\n});"}},{"configs":{"itemId":"item1","text":"-"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"pauseBtn","tooltip":"暂停执行所有选择的计划任务","text":"暂停","iconCls":"pause_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"if (!app.checkSelection())\n  return;\nWb.request({\n  url: 'm?xwl=admin/task/pause',\n  out: app.grid1,\n  success: function(resp) {\n    var rows = app.grid1.getSelection(),\n      rec = {\n        STATUS: 0,\n        PREVIOUS: null,\n        NEXT: null\n      };\n    Wb.each(rows, function(row) {\n      Wb.update(row, rec);\n    });\n  }\n});"}},{"configs":{"itemId":"resumeBtn","tooltip":"恢复执行所有选择的计划任务","text":"恢复","iconCls":"resume_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"if (!app.checkSelection())\n  return;\nWb.request({\n  url: 'm?xwl=admin/task/resume',\n  out: app.grid1,\n  success: function(resp) {\n    var rows = app.grid1.getSelection(),\n      recs = Wb.decode(resp.responseText),\n      index = 0;\n    Wb.each(rows, function(row) {\n      Wb.update(row, recs[index++]);\n    });\n  }\n});"}},{"configs":{"itemId":"item2","text":"-"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"refreshBtn","tooltip":"刷新计划任务列表","text":"刷新","iconCls":"refresh_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"app.taskStore.reload();"}},{"configs":{"itemId":"item3","text":"-"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"searchCombo","onTriggerClick":"app.search();","emptyText":"任务名称","triggerCls":"x-form-search-trigger","width":"230","displayField":"TASK_NAME","enterKeyTriggerClick":"true"},"expanded":true,"children":[{"configs":{"itemId":"store","url":"m?xwl=admin/task/search"},"expanded":false,"children":[],"type":"store"}],"type":"combo","events":{"select":"app.search();"}},{"configs":{"itemId":"resetSearchBtn","tooltip":"重置搜索条件","iconCls":"undo_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"app.search(true);"}},{"configs":{"itemId":"item4","text":"->"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"startBtn","tooltip":"启动计划任务引擎并恢复所有已经启用任务的执行","text":"启动引擎","iconCls":"run_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"Wb.request({\n  url: 'm?xwl=admin/task/start',\n  success: function(resp) {\n    app.enabled = true;\n    app.setButtons();\n    app.taskStore.reload();\n  }\n});"}},{"configs":{"itemId":"stopBtn","tooltip":"停止所有任务的执行并关闭计划任务引擎","text":"停止引擎","iconCls":"stop_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"Wb.request({\n  url: 'm?xwl=admin/task/stop',\n  success: function(resp) {\n    app.enabled = false;\n    app.setButtons();\n    app.taskStore.reload();\n  }\n});"}}],"type":"toolbar"},{"configs":{"itemId":"columns"},"expanded":true,"children":[{"configs":{"itemId":"numCol","xtype":"rownumberer"},"expanded":false,"children":[],"type":"column"},{"configs":{"itemId":"nameCol","renderer":"var s = record.get('STATUS');\nreturn Wb.getIcon(['lamp_red_icon', 'lamp_green_icon'][s], ['停用', '启用'][s]) + value;","dataIndex":"TASK_NAME","width":"230","text":"名称","autoWrap":"true"},"expanded":false,"children":[],"type":"column"},{"configs":{"itemId":"intervalTypeCol","renderer":"var name = ['秒', '分', '时', '日', '周', '月'][value],\n  express = record.get('INTERVAL_EXPRESS').split(':'),\n  text, date;\ntry {\n  switch (value) {\n    case 0:\n    case 1:\n    case 2:\n      text = '每 ' + express[0] + ' ' + name;\n      break;\n    case 3:\n      text = '每日 ' + express[0] + ':' + express[1];\n      break;\n    case 4:\n    case 5:\n      if (value == 4) text = app.weekDays[parseInt(express[0], 10) - 1][1];\n      else text = express[0];\n      date = new Date();\n      date.setHours(parseInt(express[1], 10), parseInt(express[2], 10), 0, 0);\n      if (value == 4)\n        text = '每周' + text + ' ' + Wb.dateToText(date, true);\n      else\n        text = '每月 ' + text + ' 日 ' + Wb.dateToText(date, true);\n  }\n} catch (e) {\n  text = '无效周期';\n}\nreturn text;","dataIndex":"INTERVAL_TYPE","width":"110","text":"周期","autoWrap":"true"},"expanded":false,"children":[],"type":"column"},{"configs":{"itemId":"fireTimeCol","renderer":"var previous = Wb.format(record.get('PREVIOUS'), 'Y-m-d H:i:s') || '',\n  next = Wb.format(record.get('NEXT'), 'Y-m-d H:i:s') || '';\nif (!previous && !next)\n  return '&nbsp;<br>&nbsp;';\nelse\n  return '上次：' + previous + '<br>下次：' + next;","dataIndex":"PREVIOUS","width":"170","text":"运行时间","autoWrap":"true"},"expanded":false,"children":[],"type":"column"},{"configs":{"itemId":"rangeTimeCol","renderer":"var begin = Wb.format(record.get('BEGIN_DATE'), 'Y-m-d H:i:s') || '',\n  end = Wb.format(record.get('END_DATE'), 'Y-m-d H:i:s') || '';\nif (!begin && !end)\n  return '&nbsp;<br>&nbsp;';\nelse\n  return '开始：' + begin + '<br>结束：' + end;","dataIndex":"BEGIN_DATE","width":"170","text":"起止时间","autoWrap":"true"},"expanded":false,"children":[],"type":"column"},{"configs":{"itemId":"remarkCol","dataIndex":"REMARK","flex":"1","text":"备注"},"expanded":false,"children":[],"type":"column"}],"type":"array"}],"type":"grid","events":{"itemdblclick":"app.editBtn.fireEvent('click');"}}],"type":"viewport","events":{"afterrender":"app.navKey = new Ext.KeyNav({\n  viewport: app.viewport1,\n  E: {\n    ctrl: true,\n    fn: function() {\n      app.newBtn.fireEvent('click');\n    }\n  }\n});"}}],"type":"module","events":{"finalize":"app.setButtons();","initialize":"Wb.apply(app, {\n  enabled: '{#Var.sys.task.enabled#}' == 'true',\n  weekDays: [\n    [1, '日'],\n    [2, '一'],\n    [3, '二'],\n    [4, '三'],\n    [5, '四'],\n    [6, '五'],\n    [7, '六']\n  ],\n  /**\n   * 搜索指定名称的计划任务。\n   * @param {Boolean} reset 是否重置搜索结果。\n   */\n  search: function(reset) {\n    app.searchCombo.collapse();\n    app.taskStore.load(reset ? null : {\n      out: app.grid1.down('toolbar')\n    });\n  },\n  /**\n   * 创建任务编辑窗口。\n   * @param {Function} callback 创建完成后执行的回调函数。\n   */\n  createWin: function(callback) {\n    function create() {\n      if (!(app.editWin instanceof Ext.window.Window)) {\n        new Ext.window.Window(app._editWin);\n        var config, panel = app.scriptPanel;\n        panel.update('<textarea><\/textarea>');\n        config = {\n          lineNumbers: true,\n          theme: Wb.editTheme,\n          highlightSelectionMatches: {\n            showToken: /\\w/\n          },\n          mode: {\n            name: 'text/javascript',\n            globalVars: true\n          },\n          gutters: ['CodeMirror-lint-markers'],\n          lint: true,\n          matchBrackets: true,\n          extraKeys: {\n            'Ctrl-/': 'toggleComment',\n            'Ctrl-,': function(doc) {\n              if (doc.modifyCursor)\n                doc.setCursor(doc.modifyCursor);\n            },\n            'Shift-Ctrl-F': function(doc) {\n              if (doc.options.readOnly)\n                return;\n              var cursor = doc.getCursor(),\n                scroll = doc.getScrollInfo();\n              doc.autoFormatRange({\n                line: 0,\n                ch: 0\n              }, {\n                line: Number.MAX_VALUE,\n                ch: Number.MAX_VALUE\n              });\n              doc.scrollTo(scroll.left, scroll.top);\n              doc.setCursor(cursor);\n            }\n          }\n        };\n        config.extraKeys['Alt-/'] = 'autocomplete';\n        app.scriptEditor = CodeMirror.fromTextArea(panel.el.down('textarea', true), config);\n        panel.mon(panel, 'resize', function(panel, width, height) {\n          if (app.scriptEditor && !panel.destroying) {\n            Ext.fly(app.scriptEditor.getScrollerElement()).setHeight(height);\n            app.scriptEditor.refresh();\n          }\n        });\n      }\n      Ext.callback(callback);\n    }\n    if (window.CodeMirror)\n      create();\n    else {\n      Wb.addLink(['wb/libs/cm/cmirror.css', 'wb/libs/cm/cmirror.js'],\n        create\n      );\n    }\n  },\n  checkSelection: function() {\n    if (app.grid1.getSelection().length === 0) {\n      Wb.warn('请选择至少1个计划任务。');\n      return false;\n    }\n    return true;\n  },\n  setButtons: function() {\n    app.startBtn.setDisabled(app.enabled);\n    app.stopBtn.setDisabled(!app.enabled);\n    app.resumeBtn.setDisabled(!app.enabled);\n    app.pauseBtn.setDisabled(!app.enabled);\n  }\n});"}}],"roles":{"demo":1},"title":"计划任务","iconCls":"time_icon","inframe":false,"pageLink":""}