{"hidden":false,"children":[{"configs":{"itemId":"sys.home","serverScript":"//根据新消息数量，生成Badge提示\nvar msgCount = 0,\n  msgs = Wb.decode(Wb.execute('m?xwl=sys/portal/home/get-msg-count', {\n    'sys.user': app.get('sys.user')\n  }));\nWb.each(msgs.rows, function(rec) {\n  msgCount += rec.msgCount;\n});\napp.set('badgeHtml', '<span itemId=\"badgeBtn\" class=\"wb_badge1\"' + (msgCount ? '' : ' style=\"display:none;') +\n  '\">' + (msgCount ? msgCount : '') + '<\/span>');\napp.set('msgCount', msgCount);\napp.set('treeNodes', com.wb.interact.Portal.getAppListText(request)); //使用同步方式在页面加载时加载树","serverMethod":"com.wb.interact.Portal.initHome","title":"{#Var.sys.app.title#}","headLast":"<style type=\"text/css\">\n  .pt_nav_table{\n    white-space:nowrap;\n    cursor:pointer;\n    width:100%;\n  }\n  .pt_nav_table tr{\n    line-height:23px;\n    height:23px;\n  }\n  .pt_nav_table td{\n    vertical-align:middle;\n    white-space:nowrap;\n    padding-right:15px;\n  }\n  .pt_nav_table td:hover {\n    background-color:#E5E5E5;\n  }\n  .pt_accord .pt_nav_table td:hover {\n    background-color:rgba(255,255,255,0.25);\n  }\n  .pt_menu_arrow {\n    width:6px;\n    position:absolute;\n    height:9px;\n    right:4px;\n    color:#bbb;\n  }\n  .pt_list_menu{\n    background:white;\n    cursor:default;\n  }\n  .pt_item_title{\n    height:23px;\n    font-weight:bold;\n    border-bottom:1px solid #ddd;\n    color:#2f80d1;\n    vertical-align:top;\n  }\n  .pt_card_title{\n    font-weight:bold;\n    cursor:default;\n    text-shadow: rgba(0,0,0,.25) 0 -1px 0;\n    background: linear-gradient(#334556,#2C4257),#2A3F54;\n    box-shadow: rgba(0,0,0,.25) 0 1px 0, inset rgba(255,255,255,.16) 0 1px 0;\n  }\n  .pt_module span {\n    line-height:18px;\n    padding:3px;\n    cursor:pointer;\n  }\n  .pt_module span:hover  {\n    background-color:#E5E5E5;\n  }\n  .pt_module td {\n    white-space:nowrap;\n  }\n  .pt_accord .x-accordion-item .x-accordion-hd {\n    border: 0;\n    text-shadow: rgba(0,0,0,.25) 0 -1px 0;\n    background: linear-gradient(#334556,#2C4257),#2A3F54;\n    box-shadow: rgba(0,0,0,.25) 0 1px 0, inset rgba(255,255,255,.16) 0 1px 0;\n  }\n  .pt_accord .x-accordion-hd .x-panel-header-text-container{\n    color: white;\n  }\n  .pt_accord .x-accordion-item .x-accordion-hd-sibling-expanded {\n    border: 0;\n  }\n  .pt_accord .x-accordion-hd .x-tool-expand-bottom,\n  .pt_accord .x-accordion-hd .x-tool-collapse-top {\n    background:none;\n  }\n  .pt_accord .x-tool-after-title:before{\n    display: inline-block;\n    font: normal normal normal 9px/1 FontAwesome;\n    font-size: inherit;\n    text-rendering: auto;\n    text-align: center;\n    width: 12px;\n    -webkit-font-smoothing: antialiased;\n    -moz-osx-font-smoothing: grayscale;\n    content: '\\f0c9';\n    color:#bbb;\n  }\n  .pt_accord .x-collapsed .x-tool-after-title:before{\n    content: '\\f078';\n  }\n  .pt_accord_box::-webkit-scrollbar-track{\n    background-color:#4d5b6a;\n  }\n  .pt_accord_box::-webkit-scrollbar{\n    width: 10px;\n  }\n  .pt_accord_box::-webkit-scrollbar-thumb{\n    border-radius: 10px;\n    background-color: #1ABB9C;\n  }\n<\/style>"},"expanded":true,"children":[{"configs":{"itemId":"notifySocket","name":"sys.home"},"expanded":false,"children":[],"type":"socket","events":{"success":"app.getNotifyInfo(data);"}},{"configs":{"itemId":"navIconView","createInstance":"false","hidden":"{#navIconHidden#}","tplDisplay":"{text}","viewType":"tab","deselectOnClick":"false","autoScroll":"false","height":"'100%'"},"expanded":false,"children":[{"configs":{"itemId":"store","normalName":"navIconStore","fields":"['text', 'iconCls', 'glyph', 'node', 'leaf']"},"expanded":false,"children":[],"type":"store"}],"type":"dataview","events":{"select":"if (record.data.leaf) {\n  app.openModule(record.data.node);\n  if (app.selAppRecord)\n    this.setSelection(app.selAppRecord);\n} else {\n  if (app.selAppRecord != record) {\n    app.selAppNode = record.data.node;\n    app.selAppRecord = record;\n    app.createCardView();\n  }\n}\nif (record.expCardIndex !== undefined) {\n  var container, index = record.expCardIndex;\n  if (index == -1) {\n    app.cardComp.items.items[0].el.dom.scrollTop = record.expCardPos;\n  } else {\n    container = app.cardComp.items.items[app.cardComp.items.length - 1];\n    container = container.items.items[index];\n    container.expand();\n    container.body.dom.scrollTop = record.expCardPos;\n  }\n}","beforedeselect":"var container = app.cardComp.items.items[app.cardComp.items.length - 1];\nif (container instanceof Ext.container.Container) {\n  container.items.each(function(item) {\n    if (!item.collapsed) {\n      record.expCardIndex = container.items.indexOf(item);\n      record.expCardPos = item.body.dom.scrollTop;\n      return false;\n    }\n  });\n} else {\n  record.expCardIndex = -1;\n  record.expCardPos = app.cardComp.items.items[0] ? app.cardComp.items.items[0].el.dom.scrollTop : 0;\n}"}},{"configs":{"border":"false","itemId":"notifyMenu","createInstance":"false"},"expanded":true,"children":[{"configs":{"itemId":"notifyView","badgeFieldName":"msgCount","tplDisplay":"{title}","style":"background:white;","minWidth":"200","tplIcon":"{icon}","maxWidth":"400"},"expanded":false,"children":[{"configs":{"itemId":"store","normalName":"notifyStore","fields":"['url', 'msgCount', 'title', 'icon']","url":"m?xwl=sys/portal/home/get-msg-count"},"expanded":false,"children":[],"type":"store"}],"type":"dataview","events":{"itemclick":"Wb.open(Ext.copyTo({}, record.data, 'title,icon,url'));\napp.showBadgeCount(-record.data.msgCount);\napp.notifyMenu.hide();"}}],"type":"menu"},{"configs":{"itemId":"mainMenu"},"expanded":true,"children":[{"configs":{"itemId":"buttongroup1","defaults":"{\n  padding: 5\n}","columns":"4"},"expanded":true,"children":[{"configs":{"itemId":"backBtn","glyph":"f060","tooltip":"@Str.back"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"forwardBtn","glyph":"f061","tooltip":"@Str.forward"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"homeBtn","glyph":"f015","tooltip":"@Str.home"},"expanded":false,"children":[],"type":"item","events":{"click":"app.tab.setActiveTab(app.homeCard);"}},{"configs":{"itemId":"refreshPageBtn","glyph":"f021","tooltip":"@Str.refreshPage"},"expanded":false,"children":[],"type":"item","events":{"click":"var card = app.tab.getActiveTab();\nif (card) {\n  if (card == app.homeCard) {\n    Wb.each(app.homeCard.query('portlet'), function(portlet) {\n      app.refreshPortlet(portlet);\n    });\n  } else {\n    Wb.open({\n      reloadCard: card\n    });\n  }\n}"}},{"configs":{"itemId":"findModuleBtn","glyph":"f002","tooltip":"@Str.find"},"expanded":false,"children":[],"type":"item","events":{"click":"var isTree = app.moduleView.getLayout().getActiveItem() == app.tree;\napp.moduleView.show();\nif (!isTree)\n  app.moduleView.getLayout().setActiveItem(app.treeView);\napp.searchBar.setVisible(isTree ? app.searchBar.hidden : true);\nif (app.searchBar.isVisible())\n  app.combo.focus(false, true);"}},{"configs":{"itemId":"refreshAppsBtn","glyph":"f18e","tooltip":"@Str.refreshApps"},"expanded":false,"children":[],"type":"item","events":{"click":"Wb.reload(app.tree);"}},{"configs":{"itemId":"hideView","glyph":"f00b","tooltip":"@Str.toggleView"},"expanded":false,"children":[],"type":"item","events":{"click":"app.moduleView.setVisible(!app.moduleView.isVisible());"}},{"configs":{"itemId":"hideNavIcon","glyph":"f009","tooltip":"@Str.toggleNavIcon"},"expanded":false,"children":[],"type":"item","events":{"click":"app.moduleView.show();\napp.moduleView.getLayout().setActiveItem(2);\napp.navIconView.setVisible(!app.navIconView.isVisible());\napp.createCardView();"}}],"type":"buttongroup"},{"configs":{"itemId":"line1","text":"-"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"closeCurrentItem","text":"@Str.close"},"expanded":false,"children":[],"type":"item","events":{"click":"if (app.homeCard.isVisible())\n  app.closePortal();\nelse\n  Wb.close();"}},{"configs":{"itemId":"closeOthersItem","text":"@Str.closeOthers"},"expanded":false,"children":[],"type":"item","events":{"click":"Wb.close(false);"}},{"configs":{"itemId":"closeAppsItem","text":"@Str.closeApps"},"expanded":false,"children":[],"type":"item","events":{"click":"Wb.close(true);"}},{"configs":{"itemId":"closeAllItem","text":"@Str.closeAll"},"expanded":false,"children":[],"type":"item","events":{"click":"Ext.suspendLayouts();\nWb.close(true);\napp.closePortal();\nExt.resumeLayouts(true);"}},{"configs":{"itemId":"line2","text":"-"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"viewStyleMenu","text":"@Str.moduleViewSetting"},"expanded":true,"children":[{"configs":{"itemId":"viewStyle0","glyph":"f00b","checked":"false","text":"@Str.treeView","group":"viewStyle"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"viewStyle1","glyph":"f009","checked":"false","text":"@Str.listView","group":"viewStyle"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"viewStyle2","glyph":"f039","checked":"false","text":"@Str.cardView","group":"viewStyle"},"expanded":false,"children":[],"type":"item"}],"type":"item","events":{"menuonshow":"app['viewStyle' + app.moduleView.items.indexOf(app.moduleView.getLayout().getActiveItem())].setChecked(true);","menuclick":"app.moduleView.show();\napp.moduleView.getLayout().setActiveItem(app.viewStyleMenu.menu.items.indexOf(item));"}},{"configs":{"itemId":"themeMenu","text":"@Str.theme"},"expanded":false,"children":[{"configs":{"itemId":"classicItem","checked":"true","text":"@Str.classic","group":"theme"},"expanded":true,"children":[],"type":"item"},{"configs":{"itemId":"grayItem","checked":"false","text":"@Str.gray","group":"theme"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"neptuneItem","checked":"false","text":"@Str.neptune","group":"theme"},"expanded":false,"children":[],"type":"item"}],"type":"item","events":{"menuonshow":"app[Wb.theme + 'Item'].setChecked(true);","menuclick":"if (item && item.group == 'theme') {\n  var theme = item.itemId.slice(0, -4);\n  Wb.request({\n    url: 'm?xwl=sys/portal/home/set-theme',\n    params: {\n      theme: theme\n    },\n    success: function() {\n      Wb.confirm(Str.refreshWindow, function() {\n        location.reload();\n      });\n    }\n  });\n}"}},{"configs":{"itemId":"winMenu","text":"@Str.currentAppList"},"expanded":false,"children":[{"configs":{"itemId":"item1"},"expanded":false,"children":[],"type":"item"}],"type":"item","events":{"menubeforeshow":"var items = [];\napp.tab.items.each(function(card) {\n  items.push({\n    iconCls: card.iconCls,\n    icon: card.icon,\n    text: card.title,\n    cardId: card.id,\n    tooltip: card.title == card.tab.tooltip ? '' : card.tab.tooltip\n  });\n});\nmenu.removeAll(true);\nif (items.length === 0)\n  items.push({\n    text: Str.emptyHint\n  });\nWb.sort(items, 'text');\nmenu.add(items);","menuclick":"if (item.cardId)\n  app.tab.setActiveTab(Ext.getCmp(item.cardId));"}},{"configs":{"itemId":"line3","text":"-"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"saveDesktopBtn","text":"@Str.saveDesktop"},"expanded":false,"children":[],"type":"item","events":{"click":"app.saveDesktop(1);"}},{"configs":{"itemId":"saveAsDefaultDesktopItem","hidden":"{#hideSetDefaultDesktop#}","text":"@Str.saveAsDefaultDesktop"},"expanded":false,"children":[],"type":"item","events":{"click":"Wb.confirm(Wb.format(Str.confirmDo, Str.saveAsDefaultDesktop), function() {\n  app.saveDesktop(2);\n});"}},{"configs":{"itemId":"saveAsAllDesktopItem","hidden":"{#hideSetAllDesktop#}","text":"@Str.saveAsAllDesktop"},"expanded":false,"children":[],"type":"item","events":{"click":"Wb.confirm(Wb.format(Str.confirmDo, Str.saveAsAllDesktop), function() {\n  app.saveDesktop(3);\n});"}},{"configs":{"itemId":"settingBtn","glyph":"f013","text":"@Str.setting"},"expanded":false,"children":[],"type":"item","events":{"click":"Wb.run({\n  url: 'm?xwl=sys/portal/home/sys-set',\n  success: function(scope) {\n    scope.init(app);\n  }\n});"}},{"configs":{"itemId":"line4","text":"-"},"expanded":true,"children":[],"type":"item"},{"configs":{"itemId":"logoutBtn","glyph":"f011","text":"@Str.logout"},"expanded":false,"children":[],"type":"item","events":{"click":"function doLogout() {\n  Wb.request({\n    url: 'logout',\n    success: function(resp) {\n      Wb.unloadEvents = null;\n      window.location.replace('./');\n    }\n  });\n}\nvar result = Wb.onBeforeUnload();\nif (Wb.isValue(result))\n  Wb.confirm(result + '<br><br>' + Str.confirmLogout, doLogout);\nelse\n  doLogout();"}}],"type":"menu"},{"configs":{"border":"false","itemId":"appMenu"},"expanded":false,"children":[{"configs":{"border":"false","itemId":"listPanel","style":"background:white;"},"expanded":false,"children":[],"type":"comp","events":{"beforerender":"if (Ext.isIE8m)\n  comp.width = 100;","afterrender":"comp.mon(comp.el, 'click', app.monAppClick);"}}],"type":"menu","events":{"beforeshow":"app.createListView(app.listPanel);\nif (Ext.isIE8m)\n  app.listPanel.setWidth(app.listPanel.el.down('table').getWidth());"}},{"configs":{"layout":"border","itemId":"viewport1"},"expanded":true,"children":[{"configs":{"border":"false","itemId":"topBar","html":"<table width=\"100%\" height=\"100%\" style=\"white-space:nowrap;\"><tr>\n  <td itemId=\"showMenuBtn\" style=\"font-size:18px;cursor:pointer;padding:0 5px 0 5px;\" class=\"wb_glyph\">&#xf1b3;<\/td>\n  <td itemId=\"showMenuBtn\" style=\"font-size:18px;cursor:pointer;\">{#Var.sys.app.title#}<\/td>\n  <td style=\"padding-right:50px\">&#160;<\/td>\n  <td width=\"100%\" height=\"100%\" obj=\"navIconView\"><\/td>\n  <td>\n    <span itemId=\"userBtn\" style=\"cursor:pointer;\">{#sys.dispname#}{#badgeHtml#}<\/span> | \n    <span itemId=\"menuBtn\" style=\"cursor:pointer;\">{#Str.operate#}&nbsp;&nbsp;<span class=\"wb_glyph\">&#xf107;<\/span><\/span>\n  <\/td>\n  <\/tr>\n<\/table>","style":"background:#0287cb;color:#eee;","cls":"x-unselectable","region":"north","createObject":"true","height":"35"},"expanded":false,"children":[],"type":"comp","events":{"afterrender":"comp.mon(comp.el, 'mousedown', function(e, t) {\n  switch (Ext.fly(t).getAttribute('itemId')) {\n    case 'showMenuBtn':\n      app.hideAppMenu = app.appMenu.isVisible();\n      break;\n    case 'menuBtn':\n      app.hideMainMenu = app.mainMenu.isVisible();\n      break;\n    case 'badgeBtn':\n      app.hideNotifyMenu = app.notifyMenu.isVisible && app.notifyMenu.isVisible();\n      break;\n  }\n});\ncomp.mon(comp.el, 'click', function(e, t) {\n  switch (Ext.fly(t).getAttribute('itemId')) {\n    case 'showMenuBtn':\n      if (app.hideAppMenu)\n        app.appMenu.hide();\n      else\n        app.appMenu.showBy(t, 'tl-bl?', [0, -4]);\n      break;\n    case 'userBtn':\n      Wb.run({\n        url: 'account'\n      });\n      break;\n    case 'menuBtn':\n      if (app.hideMainMenu)\n        app.mainMenu.hide();\n      else\n        app.mainMenu.showBy(t, 'tl-bl?', [0, 7]);\n      break;\n    case 'badgeBtn':\n      if (!app.notifyMenuCreated) {\n        app.notifyMenuCreated = true;\n        //按需创建实例以节省系统资源\n        new Ext.menu.Menu(app.notifyMenu);\n      }\n      if (app.hideNotifyMenu)\n        app.notifyMenu.hide();\n      else {\n        app.notifyStore.load({\n          callback: function(recs, b, succ) {\n            if (succ) {\n              var msgCount = 0;\n              Wb.each(recs, function(rec) {\n                msgCount += rec.data.msgCount;\n              });\n              app.showBadgeCount(msgCount);\n              app.notifyMenu.showBy(t, 'tl-bl?', [0, 7]);\n            }\n          }\n        });\n      }\n      break;\n  }\n});\napp.badgeBtn = comp.el.down('[itemId=badgeBtn]');"}},{"configs":{"layout":"card","border":"false","itemId":"moduleView","split":"true","hidden":"{#treeHidden#}","activeItem":"@{#viewIndex#}","width":"{#treeWidth#}","header":"false","region":"west","collapsible":"true"},"expanded":true,"children":[{"configs":{"border":"false","itemId":"tree","root":"{\n  fileName: 'Root'\n}","rootVisible":"false"},"expanded":true,"children":[{"configs":{"itemId":"tbar","hidden":"true","normalName":"searchBar"},"expanded":false,"children":[{"configs":{"itemId":"combo","onTriggerClick":"app.tree.selectPath('/Root/' + this.getValue(), 'fileName');","flex":"1","triggerCls":"x-form-search-trigger","displayField":"title","enterKeyTriggerClick":"true","listConfig":"{\n  itemTpl: [\n    '<div>{fullPath}<\/div>'\n  ]\n}","valueField":"fullFile"},"expanded":true,"children":[{"configs":{"itemId":"store","fields":"['path', 'title', 'file', 'parentFile', {\n  name: 'fullPath',\n  convert: function(v, rec) {\n    var data = rec.data;\n    if (data.path)\n      return data.path.substring(1) + '/' + data.title;\n    else return data.title;\n  }\n}, {\n  name: 'fullFile',\n  convert: function(v, rec) {\n    var data = rec.data;\n    if (data.parentFile)\n      return data.parentFile.substring(1) + '/' + data.file;\n    else return data.file;\n  }\n}]","url":"m?xwl=sys/portal/home/find"},"expanded":false,"children":[],"type":"store"}],"type":"combo","events":{"beforequery":"if (plan.query.indexOf('/') != -1 || plan.query.indexOf('\\\\') != -1) {\n  plan.combo.collapse();\n  return false;\n}","select":"combo.onTriggerClick();"}}],"type":"toolbar"},{"configs":{"itemId":"store","normalName":"treeStore","root":"{#treeNodes#}","fields":"['text', 'path', 'fileName', 'inframe', 'pageLink']","url":"m?xwl=sys/portal/home/get-tree"},"expanded":true,"children":[],"type":"treestore","events":{"success":"app.loadView(node);"}}],"type":"tree","events":{"itemclick":"if (record.isLeaf()) {\n  app.openModule(record, e.ctrlKey);\n} else {\n  if (record.isExpanded())\n    record.collapse();\n  else record.expand();\n}","tagEvents":"{\n  itemkeydown: Wb.mimicClick\n}"}},{"configs":{"border":"false","itemId":"listComp","autoScroll":"true"},"expanded":false,"children":[],"type":"comp","events":{"tagEvents":"{\n  activate: function() {\n    app.createListView(app.listComp);\n  }\n}","afterrender":"comp.mon(comp.el, 'click', app.monAppClick);"}},{"configs":{"layout":"vbox","border":"false","itemId":"cardComp","style":"@Ext.isIE8m?'':'background:#2a3f54;'","cls":"@Ext.isIE8m?'':'pt_accord'"},"expanded":true,"children":[],"type":"container","events":{"tagEvents":"{\n  activate: app.createCardView\n}","hide":"app.navIconView.hide();","show":"app.navIconView.show();"}}],"type":"panel","events":{"hide":"app.navIconView.hide();","show":"app.createListView(app.listComp);\napp.createCardView();\nif (panel.getLayout().getActiveItem() == app.cardComp)\n  app.navIconView.show();"}},{"configs":{"itemId":"tab","plugins":"'tabreorderer'","tabPosition":"@app.userOptions.moduleTabPos","region":"center"},"expanded":true,"children":[],"type":"tab","events":{"tabchange":"if (newCard && newCard.notLoaded) {\n  newCard.notLoaded = false;\n  Wb.open({\n    reloadCard: newCard,\n    frameOnly: false,\n    notActiveCard: false\n  });\n}"}}],"type":"viewport","events":{"afterrender":"app.doAfterRender();","resize":"if (app.listMenu) {\n  app.listMenu.maxWidth = width - 60;\n  app.listMenu.maxHeight = height;\n}"}}],"type":"module","events":{"finalize":"if (app.demoVersion) {\n  setTimeout(function() {\n    Wb.tip('<div style=\"text-align:center;\"><b>欢迎使用 WebBuilder！<\/b><br>WebBuilder将带给你卓越的开发体验<\/div>');\n  }, 2000);\n}","initialize":"var userDefaultOptions = {\n  moduleTabPos: 'top',\n  showMessage: true\n};\nWb.apply(app, {\n  msgCount: parseInt('{#msgCount#}', 10),\n  userOptions: Wb.apply(userDefaultOptions, Wb.decode(\"{#userOptions#}\")),\n  portletHeader: '{#Var.sys.app.portletHeader#}' == 'true',\n  demoVersion: '{#Var.sys.app.versionType#}' == 'd',\n  /**\n   * 应用用户设置的选项。\n   * @param {Window} win 设置参数的窗口对象。\n   */\n  applyOptions: function(win) {\n    var params = Wb.getStdValue(win);\n    Wb.request({\n      url: 'm?xwl=sys/portal/home/save-user-options',\n      params: {\n        userOptions: params\n      },\n      success: function(resp) {\n        Wb.apply(app.userOptions, params);\n        win.close();\n      }\n    });\n  },\n  /**\n   * 显示新消息的数量。\n   */\n  showBadgeCount: function(count) {\n    if (count < 0)\n      app.msgCount += count;\n    else\n      app.msgCount = count;\n    app.badgeBtn.setStyle('display', app.msgCount ? '' : 'none');\n    app.badgeBtn.update(app.msgCount);\n  },\n  /**\n   * 获得通知信息，在顶部工具条中增加新通知数量并显示通知。\n   * 新通知的格式为：{module:发送的模块，count:通知数量,sender:发送者,msg:通知的消息}。\n   */\n  getNotifyInfo: function(data) {\n    var path, obj = Wb.decode(data);\n    if (Ext.String.startsWith(obj.module, 'm?xwl='))\n      path = obj.module.substring(6) + '.xwl';\n    else\n      path = obj.module;\n    //当前模块没有激活在home中显示消息\n    if (path != app.tab.getActiveTab().bindFile) {\n      app.msgCount += obj.count;\n      app.showBadgeCount(app.msgCount);\n      if (app.userOptions.showMessage) {\n        Wb.tip({\n          html: obj.msg,\n          bodyStyle: 'background:white;',\n          title: Wb.format(Str.messageFrom, Wb.encodeHtml(obj.sender))\n        });\n      }\n    }\n  },\n  /**\n   * 在viewport1渲染完成后执行的方法。\n   */\n  doAfterRender: function() {\n    Ext.suspendLayouts();\n    Wb.setNavigate(app.tab, app.backBtn, app.forwardBtn);\n    app.portal = app.tab.add({\n      appScope: app,\n      itemId: 'homeCard',\n      xtype: 'portalpanel',\n      iconCls: 'home_icon',\n      title: Str.home,\n      reorderable: false\n    });\n    app.tab.setActiveTab(app.portal);\n    app.portal.add([{\n      xtype: 'portalcolumn'\n    }, {\n      xtype: 'portalcolumn'\n    }]);\n    app.populatePortlets();\n    app.populatePages();\n    app.loadView(app.tree.getRootNode());\n    Ext.resumeLayouts(true);\n  },\n  /**\n   * 加载保存的Portlets。\n   */\n  populatePortlets: function() {\n    var items = \"{#portlets#}\",\n      index = 0;\n    if (items) {\n      items = Wb.decode(items);\n      if (items.length) {\n        Wb.each(items, function(col) {\n          Wb.each(col, function(portlet) {\n            app.addPortlet(portlet, null, index);\n          });\n          index++;\n        });\n      }\n    }\n  },\n  /**\n   * 关闭所有Portlet。\n   */\n  closePortal: function() {\n    Ext.suspendLayouts();\n    app.homeCard.items.each(function(col) {\n      col.items.each(function(item) {\n        item.destroy();\n      });\n    });\n    Ext.resumeLayouts(true);\n  },\n  /**\n   * 加载保存的页面。\n   */\n  populatePages: function() {\n    var tab = app.tab;\n    tab.mon(tab.tabBar.el, 'dblclick', function() {\n      var card = tab.getActiveTab(),\n        url = card.bindFile;\n      if (!card.hasParams && url) {\n        if (Ext.String.endsWith(url, '.xwl'))\n          url = 'm?xwl=' + url.slice(0, -4);\n        window.open(url);\n      }\n    }, tab);\n    var card, tabItems = \"{#tabItems#}\";\n    if (tabItems) {\n      tabItems = Wb.decode(tabItems);\n      if (tabItems.length) {\n        Wb.each(tabItems, function(item) {\n          delete item.newWin;\n          card = Wb.open(Wb.apply(item, {\n            frameOnly: true,\n            notActiveCard: true\n          }));\n          card.notLoaded = true;\n        });\n        app.tab.setActiveTab(parseInt('{#activeIndex#}', 10));\n      }\n    }\n  },\n  showTool: function(panel, visible) {\n    Ext.suspendLayouts();\n    Wb.each(panel.header.query('tool'), function(item) {\n      item.setVisible(visible);\n    });\n    Ext.resumeLayouts(true);\n  },\n  /**\n   * 在Portal首行首列添加指定模块作为Portlet。\n   * @param {Object} config 配置项。\n   * @param {Number} [rowIndex] 行索引号，缺省为最后一行。\n   * @param {Number} [colIndex] 列索引号，缺省为0。\n   */\n  addPortlet: function(config, rowIndex, colIndex) {\n    if (config.newWin || config.inframe || config.container === false || config.download) {\n      Wb.info(Str.invalidPortlet);\n      return;\n    }\n    app.tab.setActiveTab(app.homeCard);\n    var portlet, portletObject = {\n      xtype: 'portlet',\n      layout: 'fit',\n      title: config.title,\n      iconCls: config.iconCls,\n      doRefresh: app.refreshPortlet,\n      doMaximize: app.maxPortlet,\n      pageLink: config,\n      collapsible: app.portletHeader,\n      collapsed: config.collapsed || false,\n      height: config.height || 240,\n      lastHeight: config.height || 240,\n      listeners: {\n        afterrender: {\n          single: true,\n          fn: function(me) {\n            if (app.portletHeader)\n              app.showTool(me, false);\n            else\n              me.header.setVisible(false);\n            me.mon(me.el, 'mouseenter', function() {\n              if (app.portletHeader)\n                app.showTool(me, true);\n              else\n                me.header.setVisible(true);\n            });\n            me.mon(me.el, 'mouseleave', function() {\n              if (app.portletHeader)\n                app.showTool(me, false);\n              else\n                me.header.setVisible(false);\n            });\n          }\n        },\n        resize: function(me) {\n          if (!me.collapsed)\n            me.lastHeight = me.getHeight();\n        },\n        beforecollapse: function(me) {\n          me.lastHeight = me.getHeight();\n        },\n        destroy: function(me) {\n          Wb.destroy(me.moduleScope, me);\n        }\n      }\n    };\n    if (rowIndex !== undefined)\n      portlet = app.portal.items.items[colIndex || 0].insert(rowIndex, portletObject);\n    else app.portal.items.items[colIndex || 0].add(portletObject);\n    Wb.run({\n      url: config.url,\n      contextOwner: portlet,\n      success: function(scope) {\n        var entry = Wb.optMain(scope);\n        portlet.moduleScope = scope;\n        if (entry)\n          portlet.add(entry);\n      }\n    });\n  },\n  /**\n   * 刷新Portlets。\n   */\n  refreshPortlet: function(portlet) {\n    var me = portlet || this;\n    me.removeAll();\n    Wb.destroy(me.moduleScope, me);\n    Wb.run({\n      url: me.pageLink.url,\n      contextOwner: me,\n      success: function(scope) {\n        var entry = Wb.optMain(scope);\n        me.moduleScope = scope;\n        if (entry) {\n          me.add(entry);\n        }\n      }\n    });\n  },\n  /**\n   * 最大化Portlets至Tab页。\n   */\n  maxPortlet: function() {\n    Wb.open(this.pageLink);\n  },\n  /**\n   * 获取应用模块的图标样式类。\n   */\n  getAppIcon: function(node, top) {\n    return '<img src=\"data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==\" style=\"margin:' +\n      ((top || 2) + (Wb.isNeptune ? -3 : 0)) + 'px 3px 0 4px;\" class=\"x-tree-icon ' + node.data.iconCls + '\">';\n  },\n  /**\n   * 显示应用列表。\n   */\n  showAppList: function(e, target) {\n    if (app.clearListTimer)\n      clearTimeout(app.clearListTimer);\n    if (app.showListTimer)\n      clearTimeout(app.showListTimer);\n    //如果鼠标在列表菜单上返回\n    if (app.listMenu.el && app.listMenu.el.isAncestor(target))\n      return;\n    var trEl = Ext.get(target),\n      node = app.treeStore.getNodeById(trEl.getAttribute('node'));\n    if (node.isLeaf()) {\n      app.listMenu.hide();\n      return;\n    }\n    app.showListTimer = setTimeout(function() {\n      var hasTable, adjustSize, index, html, first = true;\n      if (app.listMenu.bindTarget != target) {\n        html = '';\n        index = 0;\n        node.eachChild(function(item) {\n          if (!item.isLeaf())\n            return;\n          if (first) {\n            hasTable = true;\n            html += '<p class=\"pt_item_title\">' + app.getAppIcon(node, -2) + node.data.text +\n              '<\/p><table class=\"pt_module\" cellpadding=\"2\">';\n            first = false;\n          }\n          if (index === 0)\n            html += '<tr>';\n          index++;\n          html += '<td>' + app.getAppIcon(item, -1) + '<span node=\"' + item.id.substring(1) +\n            '\">' + item.data.text + '<\/span><\/td>';\n          if (index == 4) {\n            index = 0;\n            html += '<\/tr>';\n          }\n        });\n        if (index !== 0)\n          html += '<\/tr>';\n        if (hasTable)\n          html += '<\/table>';\n        node.eachChild(function(item) {\n          if (item.isLeaf())\n            return;\n          html += '<p class=\"pt_item_title\">' + app.getAppIcon(item, -2) + item.data.text +\n            '<\/p><table class=\"pt_module\" cellpadding=\"2\">';\n          index = 0;\n          item.cascadeBy(function(child) {\n            if (child.isLeaf()) {\n              if (index === 0)\n                html += '<tr>';\n              index++;\n              html += '<td>' + app.getAppIcon(child, -1) + '<span node=\"' + child.id.substring(1) +\n                '\">' + child.data.text + '<\/span><\/td>';\n              if (index == 4) {\n                index = 0;\n                html += '<\/tr>';\n              }\n            }\n          });\n          if (index !== 0)\n            html += '<\/tr>';\n          html += '<\/table>';\n        });\n        delete app.listMenu.width; //取消固定宽度\n        if (app.listMenu.isVisible() && app.listMenu.bindTarget)\n          app.listMenu.bindTarget.saveScrollTop = app.listMenu.el.dom.scrollTop;\n        app.listMenu.update(html);\n        adjustSize = true;\n        app.listMenu.bindTarget = target;\n      }\n      if (adjustSize) {\n        app.listMenu.maxHeight = app.viewport1.getHeight();\n      }\n      app.listMenu.show();\n      if (adjustSize) {\n        if (app.listMenu.el.isScrollable()) {\n          app.listMenu.setWidth(app.listMenu.getWidth() + 20);\n        }\n        app.listMenu.el.alignTo(trEl, 'tr?', [0, -53]);\n        if (app.listMenu.el.getLeft() === 0)\n          app.listMenu.el.setLeft(app.viewport1.getWidth() - app.listMenu.getWidth());\n      }\n      if (app.listMenu.bindTarget.saveScrollTop !== undefined)\n        app.listMenu.el.dom.scrollTop = app.listMenu.bindTarget.saveScrollTop;\n      app.listMenu.focus();\n      app.showListTimer = null;\n    }, 300);\n  },\n  /**\n   * 隐藏应用列表。\n   */\n  hideAppList: function() {\n    if (app.clearListTimer)\n      clearTimeout(app.clearListTimer);\n    if (app.showListTimer)\n      clearTimeout(app.showListTimer);\n    if (app.listMenu.isVisible()) {\n      app.clearListTimer = setTimeout(function() {\n        if (app.listMenu.bindTarget && app.listMenu.el)\n          app.listMenu.bindTarget.saveScrollTop = app.listMenu.el.dom.scrollTop;\n        app.listMenu.hide();\n        app.clearListTimer = null;\n      }, 300);\n    }\n  },\n  /**\n   * 创建应用列表视图。\n   */\n  createListView: function(listComp) {\n    if (listComp.listViewCreated)\n      return;\n    var root = app.tree.getRootNode();\n    if (!root.isLoaded() || !listComp.isVisible())\n      return;\n    var trs, html = '<table cellpadding=\"0\" cellspacing=\"0\" class=\"pt_nav_table\">';\n    root.eachChild(function(node) {\n      html += '<tr node=\"' + node.id.substring(1) +\n        '\"><td>' + app.getAppIcon(node) + node.data.text +\n        (node.isLeaf() ? '' : '<span class=\"wb_glyph pt_menu_arrow\">&#xf054;<\/span>') + '<\/td><\/tr>';\n    });\n    html += '<\/table>';\n    listComp.update(html);\n    trs = listComp.el.query('tr');\n    Wb.each(trs, function(tr) {\n      tr = Ext.fly(tr);\n      listComp.mon(tr, 'mouseenter', app.showAppList);\n      listComp.mon(tr, 'mouseleave', app.hideAppList);\n    });\n    if (!listComp.unselSetted) {\n      listComp.el.unselectable();\n      listComp.unselSetted = true;\n    }\n    if (!app.listMenu) {\n      app.listMenu = new Ext.Component({\n        border: true,\n        cls: 'pt_list_menu',\n        style: 'background-color:white;',\n        floating: true,\n        maxWidth: app.viewport1.getWidth() - 60,\n        minWidth: 120,\n        padding: 4,\n        minHeight: 30,\n        autoScroll: true,\n        listeners: {\n          afterrender: {\n            single: true,\n            fn: function(me) {\n              me.mon(me.el, 'click', app.monAppClick);\n              me.mon(me.el, 'mouseenter', app.showAppList);\n              me.mon(me.el, 'mouseleave', app.hideAppList);\n            }\n          }\n        }\n      });\n      app.appMenu.bindMenuComp = app.listMenu;\n    }\n    listComp.listViewCreated = true;\n  },\n  /**\n   * 根据节点打开指定的模块。\n   * @param {NodeInterface} record 节点对象。\n   * @param {toPortal} 是否在Portal中打开。\n   */\n  openModule: function(record, toPortal) {\n    var data = record.data,\n      pageLink = {\n        url: Wb.toUrl(data.path),\n        title: data.text,\n        iconCls: data.iconCls,\n        inframe: data.inframe\n      };\n    if (data.pageLink) {\n      Ext.apply(pageLink, Wb.decode(data.pageLink));\n    }\n    if (toPortal)\n      app.addPortlet(pageLink, 0);\n    else\n      Wb.open(pageLink);\n  },\n  /**\n   * 监听应用点击时的事件。\n   */\n  monAppClick: function(e, target) {\n    var nodeId, el = Ext.fly(target),\n      toPortal = e.ctrlKey;\n    el = el.up('[node]') || el;\n    if (el && (nodeId = el.getAttribute('node'))) {\n      var node = app.treeStore.getNodeById(nodeId);\n      if (node.isLeaf()) {\n        if (app.listMenu && app.listMenu.isVisible()) {\n          app.listMenu.bindTarget.saveScrollTop = app.listMenu.el.dom.scrollTop;\n          app.listMenu.hide();\n        }\n        if (app.appMenu.isVisible())\n          app.appMenu.hide();\n        app.openModule(node, toPortal);\n      }\n    }\n  },\n  /**\n   * 创建应用卡片（抽屉式）视图。\n   */\n  createCardView: function() {\n    var root = app.navIconView.isVisible() ? app.selAppNode : app.tree.getRootNode();\n    if (app.cardBindNode == root)\n      return;\n    else\n      app.cardBindNode = root;\n    if (!root || !root.isLoaded() || !app.cardComp.isVisible())\n      return;\n    var items = [],\n      leafItems = [],\n      allItems = [],\n      indent = app.navIconView.isVisible() ? 2 : 1,\n      hasLeaf, html, leafHtml = '';\n    root.eachChild(function(node) {\n      if (node.isLeaf()) {\n        hasLeaf = true;\n        leafHtml += '<tr><td node=\"' +\n          node.id.substring(1) + '\">' + app.getAppIcon(node) + node.data.text + '<\/td><\/tr>';\n      } else {\n        html = '<table cellpadding=\"0\" cellspacing=\"0\" class=\"pt_nav_table\">';\n        node.cascadeBy(function(child) {\n          if (child == node) return;\n          if (child.isLeaf()) {\n            html += '<tr><td style=\"padding:0 0 0 ' + (10 * (child.getDepth() - indent)) + 'px;\" node=\"' +\n              child.id.substring(1) + '\">' + app.getAppIcon(child) +\n              child.data.text + '<\/td><\/tr>';\n          } else {\n            html += '<tr><td style=\"cursor:default;padding:0 0 0 ' + (10 * (child.getDepth() - indent)) +\n              'px;\">' + app.getAppIcon(child) +\n              child.data.text + '<span class=\"wb_glyph\" style=\"margin-left:8px;\">&#xf078;<\/span><\/td><\/tr>';\n          }\n        });\n        html += '<\/table>';\n        items.push({\n          xtype: 'panel',\n          autoScroll: true,\n          bodyCls: Ext.isIE8m ? '' : 'pt_accord_box',\n          bodyStyle: Ext.isIE8m ? '' : 'background:#2a3f54;color:rgba(255,255,255,0.8);',\n          title: node.data.text,\n          iconCls: node.data.iconCls || 'null_icon',\n          html: html\n        });\n      }\n    });\n    if (hasLeaf) {\n      leafHtml = '<table cellpadding=\"0\" cellspacing=\"0\" class=\"pt_nav_table\">' + leafHtml + '<\/table>';\n      leafItems = {\n        xtype: 'box',\n        autoScroll: true,\n        cls: Ext.isIE8m ? '' : 'pt_accord_box',\n        style: Ext.isIE8m ? '' : 'background:transparent;color:rgba(255,255,255,0.8);',\n        html: leafHtml\n      };\n      if (items.length) {\n        leafItems.maxHeight = 300;\n        leafItems.listeners = {\n          afterrender: function() {\n            this.setHeight(this.getHeight() + 1);\n          }\n        };\n      } else\n        leafItems.flex = 1;\n      allItems.push(leafItems);\n    }\n    if (items.length) {\n      allItems.push({\n        xtype: 'container',\n        style: 'background:transparent;',\n        flex: 1,\n        layout: 'accordion',\n        items: items\n      });\n    }\n    Ext.suspendLayouts();\n    app.cardComp.removeAll();\n    app.cardComp.add(allItems);\n    Ext.resumeLayouts(true);\n    if (!app.cardInited) {\n      app.cardComp.el.unselectable();\n      app.cardComp.mon(app.cardComp.el, 'click', app.monAppClick);\n      app.cardInited = true;\n    }\n  },\n  /**\n   * 加载视图。\n   * @param {NodeInterface} baseNode 加载的模块目录中的节点。\n   */\n  loadView: function(baseNode) {\n    app.listComp.listViewCreated = false;\n    app.listPanel.listViewCreated = false;\n    app.selAppNode = baseNode.firstChild;\n    app.createListView(app.listComp);\n    app.cardBindNode = null;\n    app.createCardView();\n    var items = [];\n    app.treeStore.getRootNode().eachChild(function(node) {\n      items.push(Ext.copyTo({\n        node: node\n      }, node.data, 'text,iconCls,glyph,leaf'));\n    });\n    app.navIconStore.loadData(items);\n    if (items.length)\n      app.navIconView.setSelection(0);\n  },\n  /**\n   * 保存桌面状态。\n   * @param {Number} type 保存的类型。\n   */\n  saveDesktop: function(type) {\n    var pages = [],\n      portlets = [],\n      url;\n    switch (type) {\n      case 1:\n        url = 'save-desktop';\n        break;\n      case 2:\n        url = 'save-default-desktop';\n        break;\n      case 3:\n        url = 'save-all-desktop';\n        break;\n    }\n    app.tab.items.each(function(item) {\n      if (item != app.homeCard) {\n        pages.push({\n          url: item.bindFile,\n          params: item.lastPortalConfigs.params\n        });\n      }\n    });\n    app.homeCard.items.each(function(col) {\n      var items = [];\n      portlets.push(items);\n      col.items.each(function(portlet) {\n        items.push({\n          url: portlet.pageLink.url,\n          height: portlet.lastHeight,\n          collapsed: portlet.collapsed\n        });\n      });\n    });\n    Wb.request({\n      url: 'm?xwl=sys/portal/home/' + url,\n      params: {\n        treeWidth: app.moduleView.getWidth(),\n        treeCollapsed: app.moduleView.collapsed !== false,\n        treeHidden: !app.moduleView.isVisible(),\n        navIconHidden: !app.navIconView.isVisible(),\n        viewIndex: app.moduleView.items.indexOf(app.moduleView.getLayout().getActiveItem()),\n        pages: pages,\n        portlets: portlets,\n        userOptions: app.userOptions,\n        active: app.tab.items.indexOf(app.tab.getActiveTab())\n      }\n    });\n  }\n});"}}],"roles":{"default":1,"demo":1},"title":"主页","iconCls":"","inframe":false,"pageLink":"{path:'home', method: 'get', newWin: true}"}