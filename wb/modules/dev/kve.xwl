{"hidden":false,"children":[{"configs":{"itemId":"module"},"expanded":true,"children":[{"configs":{"layout":"border","itemId":"viewport1"},"expanded":true,"children":[{"configs":{"itemId":"toolbar1","region":"north"},"expanded":true,"children":[{"configs":{"itemId":"newNameBtn","tooltip":"添加新的键值项键名","text":"添加键名","iconCls":"db_form_add_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"app.setKey(true);"}},{"configs":{"itemId":"editNameBtn","tooltip":"修改选择的键值项键名","text":"修改键名","iconCls":"db_form_edit_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"app.setKey(false);"}},{"configs":{"itemId":"delNameBtn","handler":"app.delName","tooltip":"删除选择的键值项键名","text":"删除键名","iconCls":"db_form_delete_icon"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"item1","text":"-"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"newBtn","handler":"app.addItem","tooltip":"添加新的子项 (Ctrl+E)","disabled":"true","text":"添加子项","iconCls":"record_add_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"Wb.addEdit(app.grid1, {\n  KEY_NAME: app.KEY_NAME,\n  TYPE: app.TYPE\n});\napp.setButtons(false);"}},{"configs":{"itemId":"delBtn","tooltip":"删除选择的子项","disabled":"true","text":"删除子项","iconCls":"record_delete_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"Wb.remove(app.grid1);\napp.setButtons(false);"}},{"configs":{"itemId":"saveBtn","tooltip":"保存对子项所有的更改 (Ctrl+S)","disabled":"true","text":"保存子项","iconCls":"save_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"app.save();"}},{"configs":{"itemId":"rejectBtn","tooltip":"撤消最后一次保存后的所有更改","disabled":"true","text":"撤消修改","iconCls":"undo_icon"},"expanded":true,"children":[],"type":"item","events":{"click":"Wb.confirm('确定要撤消对表格所做的所有更改吗？', function() {\n  Wb.reject(app.grid1);\n  app.setButtons(true);\n});"}},{"configs":{"itemId":"item2","text":"-"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"refreshBtn","tooltip":"刷新当前键名所有子项","disabled":"true","text":"刷新子项","iconCls":"refresh_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"app.list(app.KEY_NAME, app.TYPE);"}}],"type":"toolbar"},{"configs":{"itemId":"tree1","split":"true","root":"{\n  KEY_NAME: 'Root' //必须，设置路径需要\n}","width":"200","displayField":"KEY_NAME","region":"west","title":"键名列表","tools":"Wb.getTreeTools({expand:false,collapse:false,search:true})","collapsible":"true","rootVisible":"false"},"expanded":true,"children":[{"configs":{"itemId":"store","fields":"['KEY_NAME']","url":"m?xwl=dev/kve/get-tree"},"expanded":false,"children":[],"type":"treestore"}],"type":"tree","events":{"selectionchange":"var n = selected[0];\nif (n)\n  app.list(n.data.KEY_NAME, n.data.TYPE);","itemdblclick":"app.editNameBtn.fireEvent('click');"}},{"configs":{"itemId":"grid1","editable":"true","pagingBar":"false","region":"center","title":"子项列表","loadColumns":"none","multiSelect":"true"},"expanded":true,"children":[{"configs":{"itemId":"store","pageSize":"-1","sorters":"'K'","url":"m?xwl=dev/kve/select"},"expanded":false,"children":[],"type":"store","events":{"success":"if (app.TYPE == app.grid1.columnType)\n  return;\nvar cols = Wb.getColumns(store);\ncols.splice(5, 1); //删除TYPE列\ncols.splice(1, 2); //删除KEY_ID,KEY_NAME列\ncols[1].text = '键';\nif (app.TYPE == '2') {\n  cols[1].editor.xtype = 'numberfield';\n  cols[1].editor.allowDecimal = false;\n  cols[1].editor.hideTrigger = true;\n}\ncols[1].editor.listeners = {\n  change: app.notifyChange\n};\ncols[1].width = 160;\ncols[2].text = '值';\ncols[2].editor.listeners = cols[1].editor.listeners;\ncols[2].flex = 1;\napp.grid1.columnType = app.TYPE;\napp.grid1.reconfigure(null, cols);"}}],"type":"grid"}],"type":"viewport","events":{"afterrender":"new Ext.KeyNav({\n  viewport: app.viewport1,\n  E: {\n    ctrl: true,\n    fn: function() {\n      if (!app.newBtn.disabled)\n        app.newBtn.fireEvent('click');\n    }\n  },\n  S: {\n    ctrl: true,\n    fn: app.save\n  }\n});"}}],"type":"module","events":{"beforeunload":"if (!app.saveBtn.disabled)\n  return '键值项已经被修改。';","initialize":"Wb.apply(app, {\n  /**\n   * 显示指定键名所有子项。\n   * @param {String} name 键名称。\n   * @param {String} type 类别，用于返回指定类型的数据。\n   */\n  list: function(name, type) {\n    function load() {\n      var store = app.grid1.store;\n      app.KEY_NAME = name;\n      app.TYPE = type;\n      Wb.setTitle(app.grid1, name);\n      store.removeAll();\n      store.load({\n        params: {\n          KEY_NAME: name,\n          TYPE: type\n        },\n        callback: function(a, b, succ) {\n          app.newBtn.setDisabled(!succ);\n          app.delBtn.setDisabled(!succ);\n          if (succ && app.refreshBtn.disabled)\n            app.refreshBtn.setDisabled(false);\n        }\n      });\n    }\n    if (app.saveBtn.disabled) {\n      load();\n    } else {\n      Wb.choose('子项列表已经被修改，保存所做的更改吗？',\n        function(btn) {\n          if (btn == 'yes')\n            app.save(function() {\n              load();\n            });\n          else if (btn == 'no') {\n            app.setButtons(true);\n            load();\n          }\n        });\n    }\n  },\n  save: function(callback) {\n    if (!Wb.verifyGrid(app.grid1))\n      return;\n    //检查键名重复\n    var k, isDup = false,\n      keys = {},\n      editing = Wb.findEditing(app.grid1);\n    app.grid1.store.each(function(rec) {\n      k = rec.data.K;\n      if (keys[k]) {\n        editing.startEdit(rec, 1);\n        if (editing.activeEditor)\n          editing.activeEditor.field.markInvalid('重复的键名');\n        isDup = true;\n        return false;\n      } else {\n        keys[k] = 1;\n      }\n    });\n    if (isDup)\n      return;\n    //提交保存\n    Wb.sync({\n      grid: app.grid1,\n      url: 'm?xwl=dev/kve/save',\n      params: {\n        KEY_NAME: app.KEY_NAME,\n        TYPE: app.TYPE\n      },\n      message: '正在保存中...',\n      success: function(resp) {\n        Wb.syncCreate(app.grid1, Wb.decode(resp.responseText)); //把数据更新到新建记录并完成同步\n        app.setButtons(true);\n        Ext.callback(callback);\n      }\n    });\n  },\n  setButtons: function(disabled) {\n    app.saveBtn.setDisabled(disabled);\n    app.rejectBtn.setDisabled(disabled);\n  },\n  notifyChange: function() {\n    app.setButtons(false);\n  },\n  setKey: function(isNew) {\n    var win, rec = app.tree1.getSelection()[0];\n    if (!isNew && !rec) {\n      Wb.warn('请选择要修改的键名。');\n      return;\n    }\n    win = Wb.prompt({\n      title: isNew ? '添加键名' : '修改键名',\n      iconCls: isNew ? 'db_form_add_icon' : 'db_form_edit_icon',\n      items: [{\n        fieldLabel: '名称',\n        itemId: 'KEY_NAME',\n        allowBlank: false\n      }, {\n        fieldLabel: '类别',\n        itemId: 'TYPE',\n        allowBlank: false,\n        xtype: 'combo',\n        value: 1,\n        disabled: !isNew,\n        forceSelection: true,\n        saveKeyName: isNew ? 'sys.kve.type' : null,\n        store: [\n          [1, '字符'],\n          [2, '数值']\n        ]\n      }],\n      handler: function(values) {\n        if (isNew) {\n          Wb.request({\n            url: 'm?xwl=dev/kve/add-keyname',\n            params: values,\n            success: function() {\n              var treeStore = app.tree1.store;\n              Wb.append(Wb.apply({\n                leaf: true\n              }, values), treeStore.getRootNode())[0].commit();\n              treeStore.sort('KEY_NAME');\n              win.hide();\n            }\n          });\n        } else {\n          Wb.request({\n            url: 'm?xwl=dev/kve/update-keyname',\n            params: Wb.apply({\n              oldName: rec.data.KEY_NAME\n            }, values),\n            success: function() {\n              Wb.update(rec, values);\n              win.close();\n              app.list(values.KEY_NAME, values.TYPE); //路径改变重新加载\n            }\n          });\n        }\n      }\n    });\n    if (!isNew)\n      Wb.setValue(win, rec.data);\n  },\n  delName: function() {\n    var sels = app.tree1.getSelection(),\n      keyName;\n    Wb.confirmDo(sels, function() {\n      keyName = sels[0].data.KEY_NAME;\n      Wb.request({\n        url: 'm?xwl=dev/kve/del-keyname',\n        params: {\n          KEY_NAME: keyName\n        },\n        success: function(resp) {\n          if (keyName == app.KEY_NAME)\n            app.saveBtn.setDisabled(true);\n          Wb.remove(app.tree1, sels);\n        }\n      });\n    }, 'KEY_NAME');\n  }\n});"}}],"roles":{"demo":1},"title":"键值编辑器","iconCls":"dp_icon","inframe":false,"pageLink":""}